# 部署指南（云）

本项目为 Spring Boot（Java 21 + Maven）后端，依赖：

- MySQL
- Redis
- （可选）MinIO：用于文件上传/预签名下载

推荐用 **Docker 容器化** 再上云（最通用：任意云厂商 / 任意 VM / 任意 K8s / 任意托管容器平台）。

## 1) 准备生产配置（推荐用环境变量）

项目已提供 `prod` 配置模板：`src/main/resources/application-prod.yml`。

你需要在云环境里配置以下环境变量（至少）：

- `SPRING_PROFILES_ACTIVE=prod`
- `PORT`（可选；默认 8080，一些平台会自动注入该变量）
- `DB_URL`（例如：`jdbc:mysql://<host>:3306/vegetable_forum?...`）
- `DB_USERNAME`
- `DB_PASSWORD`
- `REDIS_HOST`
- `REDIS_PORT`（可选，默认 6379）
- `JWT_SECRET`（生产务必使用强随机字符串）

如果你启用对象存储（MinIO / 兼容 S3 的服务），再额外设置：

- `MINIO_ENABLED=true`
- `MINIO_ENDPOINT`
- `MINIO_ACCESS_KEY`
- `MINIO_SECRET_KEY`
- `MINIO_BUCKET`（可选）

## 2) 构建镜像

在项目根目录执行：

```bash
docker build -t vegetable-forum-backend:latest .
```

## 3) 本地快速验证（建议）

先确保 MySQL / Redis /（可选）MinIO 可用，并完成数据库初始化（见 `docs/sql/`）。

然后启动容器：

```bash
docker run --rm -p 8080:8080 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -e PORT=8080 \
  -e DB_URL="jdbc:mysql://host.docker.internal:3306/vegetable_forum?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai" \
  -e DB_USERNAME=root \
  -e DB_PASSWORD=root \
  -e REDIS_HOST=host.docker.internal \
  -e REDIS_PORT=6379 \
  -e JWT_SECRET="change-me-to-a-strong-random-secret" \
  -e JAVA_OPTS="-Xms256m -Xmx512m" \
  vegetable-forum-backend:latest
```

健康检查：`GET /api/v1/health`

## 4) 上云的三种常见方式

### 方式 A：云主机 / VPS（最简单）

1. 买一台 Linux 云主机（Ubuntu/CentOS 均可），安装 Docker
2. 在主机上拉取镜像（自建镜像仓库 / Docker Hub / 云厂商镜像仓库）
3. 用 `docker run` 启动并注入环境变量
4. 配置安全组/防火墙放行 80/443（建议前面加 Nginx 做 HTTPS 终止与反代）

### 方式 B：托管容器（推荐，运维更少）

将镜像推到镜像仓库后，选择任意“托管容器服务”（不同云叫法不同），核心配置基本一致：

- 端口：容器监听 `8080`（本项目默认）
- 环境变量：按第 1 节配置
- 健康检查：`/api/v1/health`

### 方式 C：Kubernetes（团队/规模化）

将 MySQL/Redis 作为独立服务（或使用云托管版），本项目以 Deployment + Service + Ingress 部署：

- Deployment：镜像 + env
- Service：暴露 8080
- Ingress：域名/HTTPS

## 5) 数据库初始化

首次部署需要创建库表与测试数据（按需）：

- 建表：`docs/sql/schema.sql`
- 测试数据（可选）：`docs/sql/test-data.sql`

建议在云上使用“托管 MySQL”，并把初始化步骤纳入 CI/CD 或运维脚本。

## 6) 生产注意事项（必看）

- 不要把 `application-local.yml` 这类本地配置提交到仓库（本项目已在 `.gitignore` 忽略）。
- 生产环境务必更换 `JWT_SECRET`，并限制数据库/Redis/MinIO 的网络访问范围（仅内网可达）。
- 需要上传文件时，建议 MinIO/对象存储放到内网或专用子网，并开启 HTTPS。
