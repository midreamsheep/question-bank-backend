# 数据库表设计（MySQL）

本文档根据 `docs/产品需求文档（PRD）.md` 生成，面向 MVP 版本的“数学物理题目分享网站”。

## 1. 设计约定

- 数据库：MySQL 8.x（推荐）
- 存储引擎：InnoDB
- 字符集：`utf8mb4`
- 排序规则：`utf8mb4_0900_ai_ci`
- 主键：统一使用雪花 ID（`BIGINT`），DDL 中的 `AUTO_INCREMENT` 仅作示例，落地时移除
- 软删除：统一字段 `deleted`（0/1）
- 时间字段：统一 `created_at`、`updated_at`（`DATETIME(3)`）

## 2. 枚举与字典值

### 2.1 学科（subject）

- `MATH`：数学
- `PHYSICS`：物理

### 2.2 可见性（visibility）

- `PUBLIC`：公开（可被列表/搜索索引）
- `UNLISTED`：仅链接（不出现在列表/搜索；需凭 share_key 访问）
- `PRIVATE`：私有（仅作者与管理员可访问）

### 2.3 题目状态（problem_status）

- `DRAFT`：草稿
- `PUBLISHED`：已发布
- `DISABLED`：已下架

## 3. 表结构（DDL）

> 说明：以下 DDL 为“可落地”版本，字段可按实际产品决策再增删；如需分库分表/雪花 ID，也可将自增改为业务生成。

### 3.1 用户与权限

#### 3.1.1 用户表 `vf_user`

```sql
CREATE TABLE IF NOT EXISTS vf_user (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  username VARCHAR(64) NOT NULL COMMENT '用户名（唯一）',
  password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希（bcrypt 等）',
  nickname VARCHAR(64) NULL COMMENT '昵称',
  avatar_file_id BIGINT UNSIGNED NULL COMMENT '头像文件ID（vf_file_object.id）',
  status VARCHAR(16) NOT NULL DEFAULT 'ACTIVE' COMMENT '状态：ACTIVE/DISABLED',
  last_login_at DATETIME(3) NULL COMMENT '最近登录时间',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) COMMENT '创建时间',
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3) COMMENT '更新时间',
  deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '软删除：0否1是',
  PRIMARY KEY (id),
  UNIQUE KEY uk_user_username (username),
  KEY idx_user_status (status),
  KEY idx_user_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户';
```

#### 3.1.2 角色表 `vf_role`

```sql
CREATE TABLE IF NOT EXISTS vf_role (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  code VARCHAR(32) NOT NULL COMMENT '角色编码：USER/AUTHOR/ADMIN 等',
  name VARCHAR(64) NOT NULL COMMENT '角色名称',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_role_code (code),
  KEY idx_role_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='角色';
```

#### 3.1.3 用户角色关联表 `vf_user_role`

```sql
CREATE TABLE IF NOT EXISTS vf_user_role (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  role_id BIGINT UNSIGNED NOT NULL COMMENT '角色ID',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_user_role (user_id, role_id),
  KEY idx_user_role_user (user_id),
  KEY idx_user_role_role (role_id),
  KEY idx_user_role_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户-角色关联';
```

### 3.2 分类/题型/标签

#### 3.2.1 分类表 `vf_category`（支持层级）

```sql
CREATE TABLE IF NOT EXISTS vf_category (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  subject VARCHAR(64) NULL COMMENT '学科（字符串；可为空表示跨学科）',
  parent_id BIGINT UNSIGNED NULL COMMENT '父分类ID',
  name VARCHAR(128) NOT NULL COMMENT '分类名称',
  description VARCHAR(512) NULL COMMENT '描述',
  sort_order INT NOT NULL DEFAULT 0 COMMENT '排序（越小越靠前）',
  enabled TINYINT(1) NOT NULL DEFAULT 1 COMMENT '是否启用',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_category_parent (parent_id),
  KEY idx_category_subject (subject),
  KEY idx_category_enabled (enabled),
  KEY idx_category_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='分类（层级）';
```

#### 3.2.2 题型表 `vf_problem_type`

```sql
CREATE TABLE IF NOT EXISTS vf_problem_type (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  subject VARCHAR(64) NULL COMMENT '学科（字符串；可为空表示跨学科）',
  name VARCHAR(128) NOT NULL COMMENT '题型名称',
  description VARCHAR(512) NULL COMMENT '题型说明',
  sort_order INT NOT NULL DEFAULT 0 COMMENT '排序',
  enabled TINYINT(1) NOT NULL DEFAULT 1 COMMENT '是否启用',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_problem_type_name (name),
  KEY idx_problem_type_subject (subject),
  KEY idx_problem_type_enabled (enabled),
  KEY idx_problem_type_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='题型';
```

#### 3.2.3 标签表 `vf_tag`

```sql
CREATE TABLE IF NOT EXISTS vf_tag (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  subject VARCHAR(64) NULL COMMENT '学科（字符串；可为空表示跨学科）',
  name VARCHAR(64) NOT NULL COMMENT '标签名称（唯一）',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_tag_name (name),
  KEY idx_tag_subject (subject),
  KEY idx_tag_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='标签';
```

### 3.3 题目与关联关系

#### 3.3.1 题目表 `vf_problem`

```sql
CREATE TABLE IF NOT EXISTS vf_problem (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  author_id BIGINT UNSIGNED NOT NULL COMMENT '作者用户ID',

  title VARCHAR(256) NOT NULL COMMENT '标题',
  subject VARCHAR(64) NOT NULL COMMENT '学科（字符串）',
  difficulty TINYINT UNSIGNED NOT NULL DEFAULT 3 COMMENT '难度：1-5',

  source_type VARCHAR(32) NULL COMMENT '来源类型：SELF/BOOK/CONTEST/WEB 等',
  source_text VARCHAR(512) NULL COMMENT '来源说明（教材名/链接等）',
  is_original TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否原创',

  statement_format VARCHAR(16) NOT NULL DEFAULT 'MARKDOWN' COMMENT '题干格式：MARKDOWN/LATEX',
  statement_content MEDIUMTEXT NOT NULL COMMENT '题干内容（按格式解释）',
  solution_format VARCHAR(16) NULL COMMENT '解答格式：MARKDOWN/LATEX',
  solution_content MEDIUMTEXT NULL COMMENT '解答内容（按格式解释）',

  visibility VARCHAR(16) NOT NULL DEFAULT 'PUBLIC' COMMENT '可见性：PUBLIC/UNLISTED/PRIVATE',
  share_key CHAR(32) NULL COMMENT '仅链接访问凭证（UNLISTED时使用）',

  status VARCHAR(16) NOT NULL DEFAULT 'DRAFT' COMMENT '状态：DRAFT/PUBLISHED/DISABLED',
  published_at DATETIME(3) NULL COMMENT '发布时间（首次发布）',
  last_modified_at DATETIME(3) NULL COMMENT '内容更新时间（业务口径）',

  view_count BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '浏览数（可选，后续可改为异步统计）',
  favorite_count BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '收藏数（可选）',

  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_problem_share_key (share_key),
  KEY idx_problem_author (author_id),
  KEY idx_problem_subject (subject),
  KEY idx_problem_status (status),
  KEY idx_problem_visibility (visibility),
  KEY idx_problem_published_at (published_at),
  KEY idx_problem_deleted (deleted),
  FULLTEXT KEY ft_problem_search (title, statement_content, solution_content)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='题目';
```

> 说明：`FULLTEXT` 用于关键字搜索（MVP 可先做标题，后续再扩展）。

> 说明：`statement_format/solution_format` 用于标识内容解释方式：
>
> - `MARKDOWN`：Markdown 文本（可在 Markdown 中嵌入 LaTeX 片段，由前端渲染策略决定）
> - `LATEX`：LaTeX 源码（整段内容作为公式/排版内容处理）

#### 3.3.2 题目-分类关联 `vf_problem_category`

```sql
CREATE TABLE IF NOT EXISTS vf_problem_category (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  problem_id BIGINT UNSIGNED NOT NULL COMMENT '题目ID',
  category_id BIGINT UNSIGNED NOT NULL COMMENT '分类ID',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_problem_category (problem_id, category_id),
  KEY idx_problem_category_problem (problem_id),
  KEY idx_problem_category_category (category_id),
  KEY idx_problem_category_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='题目-分类关联';
```

#### 3.3.3 题目-题型关联 `vf_problem_type_rel`

```sql
CREATE TABLE IF NOT EXISTS vf_problem_type_rel (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  problem_id BIGINT UNSIGNED NOT NULL COMMENT '题目ID',
  type_id BIGINT UNSIGNED NOT NULL COMMENT '题型ID（vf_problem_type.id）',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_problem_type_rel (problem_id, type_id),
  KEY idx_problem_type_rel_problem (problem_id),
  KEY idx_problem_type_rel_type (type_id),
  KEY idx_problem_type_rel_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='题目-题型关联';
```

#### 3.3.4 题目-标签关联 `vf_problem_tag`

```sql
CREATE TABLE IF NOT EXISTS vf_problem_tag (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  problem_id BIGINT UNSIGNED NOT NULL COMMENT '题目ID',
  tag_id BIGINT UNSIGNED NOT NULL COMMENT '标签ID',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_problem_tag (problem_id, tag_id),
  KEY idx_problem_tag_problem (problem_id),
  KEY idx_problem_tag_tag (tag_id),
  KEY idx_problem_tag_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='题目-标签关联';
```

### 3.4 题单/合集

#### 3.4.1 题单表 `vf_collection`

```sql
CREATE TABLE IF NOT EXISTS vf_collection (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  author_id BIGINT UNSIGNED NOT NULL COMMENT '作者用户ID',
  name VARCHAR(128) NOT NULL COMMENT '题单名称',
  description VARCHAR(1024) NULL COMMENT '简介',

  visibility VARCHAR(16) NOT NULL DEFAULT 'PUBLIC' COMMENT '可见性：PUBLIC/UNLISTED/PRIVATE',
  share_key CHAR(32) NULL COMMENT '仅链接访问凭证（UNLISTED时使用）',

  status VARCHAR(16) NOT NULL DEFAULT 'ACTIVE' COMMENT '状态：ACTIVE/DISABLED',
  item_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '题目数量（可选）',

  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_collection_share_key (share_key),
  KEY idx_collection_author (author_id),
  KEY idx_collection_visibility (visibility),
  KEY idx_collection_status (status),
  KEY idx_collection_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='题单/合集';
```

#### 3.4.2 题单条目表 `vf_collection_item`

```sql
CREATE TABLE IF NOT EXISTS vf_collection_item (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  collection_id BIGINT UNSIGNED NOT NULL COMMENT '题单ID',
  problem_id BIGINT UNSIGNED NOT NULL COMMENT '题目ID',
  sort_order INT NOT NULL DEFAULT 0 COMMENT '排序（越小越靠前）',
  added_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) COMMENT '加入时间',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_collection_problem (collection_id, problem_id),
  KEY idx_collection_item_collection (collection_id),
  KEY idx_collection_item_problem (problem_id),
  KEY idx_collection_item_sort (collection_id, sort_order),
  KEY idx_collection_item_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='题单条目';
```

### 3.5 每日一题

#### 3.5.1 每日一题表 `vf_daily_problem`

```sql
CREATE TABLE IF NOT EXISTS vf_daily_problem (
  id BIGINT UNSIGNED NOT NULL COMMENT '主键（雪花ID）',
  day DATE NOT NULL COMMENT '日期',
  problem_id BIGINT UNSIGNED NOT NULL COMMENT '题目ID',
  status VARCHAR(16) NOT NULL DEFAULT 'PUBLISHED' COMMENT '状态：PUBLISHED/REVOKED',
  copywriting VARCHAR(1024) NULL COMMENT '运营文案（推荐理由/提示）',
  operator_id BIGINT UNSIGNED NOT NULL COMMENT '操作人（发布/撤回用户）ID',
  published_at DATETIME(3) NULL COMMENT '发布时间',
  revoked_at DATETIME(3) NULL COMMENT '撤回时间',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_daily_problem_day_problem (day, problem_id),
  KEY idx_daily_problem_problem (problem_id),
  KEY idx_daily_problem_day (day),
  KEY idx_daily_problem_published_at (published_at),
  KEY idx_daily_problem_status (status),
  KEY idx_daily_problem_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='每日一题';
```

#### 3.5.2 每日一题操作日志 `vf_daily_problem_log`（建议）

```sql
CREATE TABLE IF NOT EXISTS vf_daily_problem_log (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  daily_problem_id BIGINT UNSIGNED NOT NULL COMMENT '每日一题ID',
  action VARCHAR(32) NOT NULL COMMENT '动作：PUBLISH/REVOKE/REPLACE',
  operator_id BIGINT UNSIGNED NOT NULL COMMENT '操作人ID',
  detail VARCHAR(2048) NULL COMMENT '变更详情（JSON字符串/描述）',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_daily_problem_log_daily (daily_problem_id),
  KEY idx_daily_problem_log_operator (operator_id),
  KEY idx_daily_problem_log_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='每日一题操作日志';
```

### 3.6 文件与图片（对象存储）

#### 3.7.1 文件对象表 `vf_file_object`

```sql
CREATE TABLE IF NOT EXISTS vf_file_object (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  share_key CHAR(32) NOT NULL COMMENT '分享 key（永久链接凭证）',
  object_key VARCHAR(512) NOT NULL COMMENT '对象存储 key（MinIO object）',
  original_filename VARCHAR(256) NULL COMMENT '原始文件名',
  content_type VARCHAR(128) NULL COMMENT 'MIME 类型',
  size BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '大小（字节）',
  uploader_id BIGINT UNSIGNED NULL COMMENT '上传者用户ID',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_file_share_key (share_key),
  UNIQUE KEY uk_file_object_key (object_key),
  KEY idx_file_uploader (uploader_id),
  KEY idx_file_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='文件对象（MinIO 元数据）';
```

#### 3.7.2 题目-文件关联 `vf_problem_file`

```sql
CREATE TABLE IF NOT EXISTS vf_problem_file (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  problem_id BIGINT UNSIGNED NOT NULL COMMENT '题目ID',
  file_id BIGINT UNSIGNED NOT NULL COMMENT '文件ID（vf_file_object.id）',
  role VARCHAR(32) NOT NULL COMMENT '用途：STATEMENT/SOLUTION',
  sort_order INT NOT NULL DEFAULT 0 COMMENT '排序',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_problem_file (problem_id, file_id, role),
  KEY idx_problem_file_problem (problem_id),
  KEY idx_problem_file_file (file_id),
  KEY idx_problem_file_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='题目-文件关联';
```

### 3.8 收藏（MVP 可选但建议预留）

#### 3.8.1 题目收藏 `vf_user_favorite_problem`

```sql
CREATE TABLE IF NOT EXISTS vf_user_favorite_problem (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  problem_id BIGINT UNSIGNED NOT NULL COMMENT '题目ID',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_user_fav_problem (user_id, problem_id),
  KEY idx_user_fav_problem_user (user_id),
  KEY idx_user_fav_problem_problem (problem_id),
  KEY idx_user_fav_problem_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户收藏题目';
```

#### 3.8.2 题单收藏 `vf_user_favorite_collection`

```sql
CREATE TABLE IF NOT EXISTS vf_user_favorite_collection (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  collection_id BIGINT UNSIGNED NOT NULL COMMENT '题单ID',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_user_fav_collection (user_id, collection_id),
  KEY idx_user_fav_collection_user (user_id),
  KEY idx_user_fav_collection_collection (collection_id),
  KEY idx_user_fav_collection_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户收藏题单';
```

### 3.9 点赞（V1.1）

#### 3.9.1 题目点赞 `vf_user_like_problem`

```sql
CREATE TABLE IF NOT EXISTS vf_user_like_problem (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  problem_id BIGINT UNSIGNED NOT NULL COMMENT '题目ID',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_user_like_problem (user_id, problem_id),
  KEY idx_user_like_problem_user (user_id),
  KEY idx_user_like_problem_problem (problem_id),
  KEY idx_user_like_problem_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户点赞题目';
```

> 说明：题目表建议预留 `like_count` 作为聚合字段，避免每次列表/详情聚合统计。

### 3.10 评论（V1.1）

#### 3.10.1 题目评论 `vf_problem_comment`

```sql
CREATE TABLE IF NOT EXISTS vf_problem_comment (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  problem_id BIGINT UNSIGNED NOT NULL COMMENT '题目ID',
  user_id BIGINT UNSIGNED NOT NULL COMMENT '评论用户ID',
  parent_id BIGINT UNSIGNED NULL COMMENT '父评论ID（楼中楼）',
  reply_to_comment_id BIGINT UNSIGNED NULL COMMENT '回复的评论ID（可选）',
  content VARCHAR(2000) NOT NULL COMMENT '评论内容',
  like_count BIGINT NOT NULL DEFAULT 0 COMMENT '点赞数',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_problem_comment_problem (problem_id),
  KEY idx_problem_comment_parent (parent_id),
  KEY idx_problem_comment_user (user_id),
  KEY idx_problem_comment_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='题目评论';
```

#### 3.10.2 评论点赞 `vf_user_like_comment`

```sql
CREATE TABLE IF NOT EXISTS vf_user_like_comment (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  comment_id BIGINT UNSIGNED NOT NULL COMMENT '评论ID',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_user_like_comment (user_id, comment_id),
  KEY idx_user_like_comment_user (user_id),
  KEY idx_user_like_comment_comment (comment_id),
  KEY idx_user_like_comment_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户点赞评论';
```

### 3.11 举报（可选，后续）

#### 3.11.1 举报表 `vf_report`

```sql
CREATE TABLE IF NOT EXISTS vf_report (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  reporter_id BIGINT UNSIGNED NOT NULL COMMENT '举报人用户ID',
  target_type VARCHAR(32) NOT NULL COMMENT '目标类型：PROBLEM/COMMENT',
  target_id BIGINT UNSIGNED NOT NULL COMMENT '目标ID',
  reason VARCHAR(1024) NOT NULL COMMENT '举报原因',
  status VARCHAR(16) NOT NULL COMMENT '状态：OPEN/RESOLVED/REJECTED',
  handler_id BIGINT UNSIGNED NULL COMMENT '处理人用户ID（管理员）',
  handled_at DATETIME(3) NULL COMMENT '处理时间',
  handling_note VARCHAR(1024) NULL COMMENT '处理备注',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  deleted TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_report_target (target_type, target_id),
  KEY idx_report_status (status),
  KEY idx_report_reporter (reporter_id),
  KEY idx_report_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='举报';
```

## 4. 索引与查询建议

- 题目列表常用条件：`subject + status + visibility + published_at` → 已建立组合索引的基础字段（可按实际查询再加联合索引）。
- 搜索：`FULLTEXT(title, statement_md, solution_md)`，MVP 可先只对 `title` 做 FULLTEXT 或使用前缀 LIKE。
- 每日一题：`day` 唯一索引，按日期查询 O(1)。

## 5. 待产品确认点（影响表结构）

- 审核策略：当前已取消“先审后发”，题目由作者直接发布（无需 `vf_problem_review`）
- “仅链接”访问策略：是否强制 `share_key`（本文档建议 UNLISTED 必须 share_key）
- 题目编辑的版本化：是否需要 `vf_problem_revision`（后续可加）
- 评论/讨论：PRD 规划 V1.1，已补充 `vf_problem_comment`（扁平结构），是否需要楼中楼/回复（后续）
