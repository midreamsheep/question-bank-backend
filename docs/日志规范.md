# 日志规范（强制）

本规范用于统一项目日志的**级别、格式、内容、敏感信息处理**以及**链路追踪**，并作为代码评审与上线准入的一部分。

## 1. 目标

- 能快速定位问题：通过 `traceId` 串联一次请求的关键日志。
- 能快速排障：错误日志必须包含足够上下文（但不泄露敏感信息）。
- 可观测：关键业务动作、关键异常、关键性能点可追踪。
- 可控：避免日志洪泛与无意义噪声，控制成本。

## 2. 日志级别定义

- `ERROR`：服务不可用/功能不可用/未处理异常/关键依赖失败（必须能触发告警）
- `WARN`：可预期的异常或降级/重试/参数非法/业务校验不通过（不一定告警）
- `INFO`：关键业务事件（登录成功/创建帖子成功/支付回调处理完成等），以及服务启动、重要配置摘要
- `DEBUG`：调试信息（开发/排障使用，生产默认关闭）
- `TRACE`：极细粒度跟踪（禁止在生产默认开启）

原则：

- 不允许使用 `System.out.println`。
- 不允许将正常流程的高频日志打到 `WARN/ERROR`。
- 生产环境禁止打印过多 `DEBUG/TRACE`。

## 3. 日志内容规范（必须）

每条日志建议包含以下要素（至少保证能定位到请求与代码位置）：

- `traceId`：请求链路标识（必须）
- `logger`：类名/模块名（框架自动提供）
- `event`：事件名（建议）
- `key fields`：关键字段（建议，如 `userId`、`postId`、`orderId`）
- `durationMs`：耗时（针对关键链路建议）

示例（推荐写法）：

```java
log.info("event=post_create_success userId={} postId={} durationMs={}", userId, postId, durationMs);
```

## 4. 敏感信息与合规（必须）

严禁写入日志：

- 明文密码、验证码、JWT 全量 token
- 身份证号/银行卡号等高敏字段（如必须记录，需脱敏）
- 用户隐私数据（手机号/邮箱等）必须经过脱敏或仅记录 hash/部分字段

建议：

- 对外部接口请求/响应只记录必要字段与摘要（必要时截断）
- 对用户输入进行长度限制/截断，避免日志注入与超长日志

## 5. 异常日志规范（必须）

- **业务异常**（可预期）：
  - 级别：`WARN`
  - 内容：错误码、提示信息、关键业务字段
  - 一般不需要打印完整堆栈（除非排障需要）

- **未处理异常**（不可预期）：
  - 级别：`ERROR`
  - 必须打印堆栈，并包含 `traceId`
  - 返回给客户端的消息需避免暴露内部细节

## 6. 链路追踪（traceId）（强制）

- 每个请求必须有 `traceId`：
  - 若请求头携带 `X-Request-Id`，优先使用
  - 否则服务端生成新的 `traceId`
- `traceId` 必须写入日志 MDC，并建议回传到响应头（便于联调/排障）。

## 7. 性能日志（建议）

对关键接口/关键用例建议记录：

- `durationMs`
- 命中/未命中缓存（如 Redis）
- 关键 SQL 次数/慢查询摘要（避免打印全量 SQL 参数）

## 8. 配置建议（可按环境调整）

- `local`：`logging.level.<root>=INFO`，业务包可适当 `DEBUG`
- `test`：保持 `INFO`，避免日志噪声影响 CI
- `prod`：`INFO/WARN/ERROR`，禁止默认 `DEBUG/TRACE`

