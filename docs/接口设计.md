# 接口设计（API）

本文档用于指导后端实现与前端/测试联调，覆盖 MVP 的核心接口：题目提交（Markdown/LaTeX）、分类/题型/标签、题单分享、每日一题（手动推送）、文件存储（MinIO）、鉴权（JWT）。

## 1. 通用约定

### 1.1 Base URL

- Base Path：`/api/v1`

### 1.2 认证与请求头

- JWT：`Authorization: Bearer <token>`
- traceId：客户端可传 `X-Request-Id`，服务端会透传或生成，并回写到响应头 `X-Request-Id`

### 1.3 统一响应体

统一响应结构：

```json
{
  "code": 0,
  "message": "OK",
  "data": {}
}
```

- `code=0` 表示成功
- 失败时 `data` 通常为 `null`

### 1.4 常用错误码（建议）

| code | 含义 | HTTP |
| --- | --- | --- |
| 40000 | 参数错误 | 400 |
| 40100 | 未认证 | 401 |
| 40300 | 无权限 | 403 |
| 40400 | 资源不存在 | 404 |
| 50000 | 服务端错误 | 500 |
| 50300 | 服务不可用（依赖未启用/不可用） | 503 |

### 1.5 分页约定（建议）

列表接口采用页码分页：

- `page`：从 1 开始
- `pageSize`：默认 20，最大 100

统一分页响应建议：

```json
{
  "items": [],
  "page": 1,
  "pageSize": 20,
  "total": 0
}
```

> 说明：后端将以 `ApiResponse` 包裹上述分页结构。

### 1.6 内容格式约定（题干/解答）

题干与解答均支持两种格式：

- `MARKDOWN`
- `LATEX`

后端不负责 Markdown 与 LaTeX 的互相转换，仅存储并返回格式信息；渲染由前端决定。

## 2. 鉴权接口

### 2.1 登录

- `POST /api/v1/auth/login`
- 认证：否

请求：

```json
{
  "username": "demo",
  "password": "demo"
}
```

响应：

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "token": "xxx.yyy.zzz"
  }
}
```

### 2.2 注册

- `POST /api/v1/auth/register`
- 认证：否

请求：

```json
{
  "username": "demo",
  "password": "demo123",
  "nickname": "Demo"
}
```

响应：

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "userId": 1,
    "token": "xxx.yyy.zzz"
  }
}
```

### 2.3 退出登录

- `POST /api/v1/auth/logout`
- 认证：是

响应：`ApiResponse<Void>`

### 2.4 用户接口

#### 2.4.1 获取当前用户资料

- `GET /api/v1/users/me`
- 认证：是

#### 2.4.2 更新当前用户资料

- `PUT /api/v1/users/me`
- 认证：是

请求：

```json
{
  "nickname": "Demo",
  "avatarFileId": 123
}
```

#### 2.4.3 修改当前用户密码

- `PUT /api/v1/users/me/password`
- 认证：是

请求：

```json
{
  "oldPassword": "demo123",
  "newPassword": "demo456"
}
```

#### 2.4.4 我的题目列表（MVP）

- `GET /api/v1/users/me/problems`
- 认证：是

Query（建议）：

- `status`（可选）：`DRAFT/PUBLISHED/DISABLED`
- `page`、`pageSize`

#### 2.4.5 我的题单列表（MVP）

- `GET /api/v1/users/me/collections`
- 认证：是

Query（建议）：

- `status`（可选）：`ACTIVE/DISABLED`
- `page`、`pageSize`

#### 2.4.6 我收藏的题目列表（MVP）

- `GET /api/v1/users/me/favorites/problems`
- 认证：是

Query：`page`、`pageSize`

#### 2.4.7 我收藏的题单列表（MVP）

- `GET /api/v1/users/me/favorites/collections`
- 认证：是

Query：`page`、`pageSize`

#### 2.4.8 我点赞的题目列表（V1.1）

- `GET /api/v1/users/me/likes/problems`
- 认证：是

Query：`page`、`pageSize`

#### 2.4.9 我点赞的评论列表（V1.1）

- `GET /api/v1/users/me/likes/comments`
- 认证：是

Query：`page`、`pageSize`

## 3. 系统接口

### 3.1 健康检查

- `GET /api/v1/health`
- 认证：否

响应：`ApiResponse<Void>`

## 4. 文件存储（MinIO）

> 说明：为方便前端 `<img src>` 直接使用，上传后会生成 `shareKey/shareUrl` 作为“永久链接”（无需登录，持有链接即可访问）。

### 4.1 上传文件

- `POST /api/v1/files`
- 认证：是
- Content-Type：`multipart/form-data`

参数：

- `file`：文件

响应：

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "id": 123,
    "shareKey": "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
    "shareUrl": "/api/v1/files/share/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
    "objectKey": "user/demo/20260101/xxx-a.png",
    "originalFilename": "a.png",
    "size": 12345,
    "contentType": "image/png"
  }
}
```

错误：

- MinIO 未启用：`50300`

### 4.2 获取下载预签名 URL

- `GET /api/v1/files/presigned-get-url`
- 认证：是

Query：

- `fileId`（与 objectKey 二选一）
- `objectKey`（与 fileId 二选一）
- `expiresSeconds`（可选，默认 3600，最小 60）

响应：

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "url": "https://..."
  }
}
```

### 4.3 永久链接访问（推荐给前端 img/src）

- `GET /api/v1/files/share/{shareKey}`
- 认证：否
- 返回：二进制文件流（非 ApiResponse 包裹）

### 4.4 通过 fileId 获取 shareUrl（头像等场景推荐）

- `GET /api/v1/files/share-url?fileId=...`
- 认证：是
- 响应：`ApiResponse<{shareKey, shareUrl}>`

## 5. 题目（Problem）

### 5.1 数据结构（建议）

#### 5.1.1 题目简要信息（ProblemSummary）

```json
{
  "id": 1,
  "title": "一道不等式题",
  "subject": "MATH",
  "difficulty": 3,
  "status": "PUBLISHED",
  "visibility": "PUBLIC",
  "publishedAt": "2026-01-28T10:00:00+08:00",
  "author": {
    "id": 1,
    "nickname": "张三",
    "displayName": "张三"
  },
  "tagIds": [1, 3],
  "tags": [
    { "id": 1, "name": "AM-GM" },
    { "id": 3, "name": "Bounds" }
  ]
}
```

#### 5.1.2 题目详情（ProblemDetail）

```json
{
  "id": 1,
  "title": "一道不等式题",
  "subject": "MATH",
  "difficulty": 3,
  "statementFormat": "MARKDOWN",
  "statement": "题干内容...",
  "solutionFormat": "LATEX",
  "solution": "\\\\text{解：...}",
  "visibility": "PUBLIC",
  "shareKey": null,
  "status": "PUBLISHED",
  "author": {
    "id": 1,
    "nickname": "张三",
    "displayName": "张三"
  },
  "tagIds": [1, 3],
  "tags": [
    { "id": 1, "name": "AM-GM" },
    { "id": 3, "name": "Bounds" }
  ]
}
```

### 5.2 创建题目（草稿）

- `POST /api/v1/problems`
- 认证：是

请求（MVP 建议支持）：

```json
{
  "title": "一道不等式题",
  "subject": "MATH",
  "difficulty": 3,
  "statementFormat": "MARKDOWN",
  "statement": "题干 Markdown ...",
  "solutionFormat": "LATEX",
  "solution": "\\\\text{解：...}",
  "visibility": "PUBLIC"
}
```

响应：

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "id": 1001,
    "status": "DRAFT",
    "visibility": "PUBLIC",
    "shareKey": null
  }
}
```

规则：

- `difficulty` 必须在 1-5
- `statementFormat/statement` 必填
- `solution` 可选；若填写 `solution` 则 `solutionFormat` 必填
- 若 `visibility=UNLISTED`：
  - 由服务端生成 `shareKey` 并返回

### 5.3 更新题目（草稿）

- `PUT /api/v1/problems/{id}`
- 认证：是（仅作者或管理员）

请求：同创建结构（可允许部分字段更新，后端决定）

### 5.4 发布题目

- `POST /api/v1/problems/{id}/publish`
- 认证：是（仅作者）

发布请求（可选）：

```json
{
  "subject": "MATH",
  "tagIds": [1, 3],
  "newTags": ["AM-GM", "Bounds"]
}
```

响应：返回最新状态（`PUBLISHED`）

### 5.5 题目列表

- `GET /api/v1/problems`
- 认证：否（仅返回 PUBLIC 的 PUBLISHED）

Query（建议）：

- `subject`：字符串（可自定义）
- `tagIds`（多选，OR 语义；推荐写法：`tagIds=1&tagIds=3`）
- `difficultyMin`、`difficultyMax`
- `keyword`：关键字（MVP 可先匹配 title）
- `sort`：`LATEST/PUBLISHED_AT/DIFFICULTY/HOT`
- `page`、`pageSize`

响应：`ApiResponse<PageResponse<ProblemSummary>>`

### 5.6 题目详情

- `GET /api/v1/problems/{id}`
- 认证：按可见性决定

访问规则（建议）：

- `PUBLIC`：无需登录可访问（但仅限 PUBLISHED）
- `UNLISTED`：通过 `shareKey` 访问（建议提供专用接口：`/problems/share/{shareKey}`）
- `PRIVATE`：仅作者/管理员可访问

### 5.7 仅链接访问

- `GET /api/v1/problems/share/{shareKey}`
- 认证：否

响应：`ProblemDetail`

### 5.8 删除/下架（后台策略）

- `DELETE /api/v1/problems/{id}`：作者删除自己的草稿（软删除）
- `POST /api/v1/problems/{id}/disable`：作者下架自己的已发布题目
- `POST /api/v1/admin/problems/{id}/disable`：管理员下架

> 说明：具体接口与策略可按产品再细化；MVP 可先保留最小集合（创建/更新/列表/详情）。

### 5.10 收藏（MVP）

- `POST /api/v1/problems/{id}/favorite`：收藏题目
- `DELETE /api/v1/problems/{id}/favorite`：取消收藏题目

### 5.11 点赞（V1.1）

- `POST /api/v1/problems/{id}/like`：点赞题目
- `DELETE /api/v1/problems/{id}/like`：取消点赞题目

### 5.12 评论（V1.1）

- `GET /api/v1/problems/{id}/comments`：评论列表（分页，公开题目可匿名查看）
  - Query：`parentId`（可选；不传表示顶层评论）、`page`、`pageSize`
- `POST /api/v1/problems/{id}/comments`：创建评论（支持楼中楼）
  - body：
    - `content`（必填）
    - `parentId`（可选；回复某条评论时传）
    - `replyToCommentId`（可选；为空时默认等于 parentId）
- `DELETE /api/v1/problems/{id}/comments/{commentId}`：删除评论（作者或管理员）
- `POST /api/v1/problems/{id}/comments/{commentId}/like`：点赞评论
- `DELETE /api/v1/problems/{id}/comments/{commentId}/like`：取消点赞评论

## 6. 分类 / 题型 / 标签

### 6.1 分类列表

- `GET /api/v1/categories`
- 认证：否

Query：

- `subject`（可选）

### 6.2 题型列表

- `GET /api/v1/problem-types`
- 认证：否

Query：

- `subject`（可选）

### 6.3 标签列表（搜索）

- `GET /api/v1/tags`
- 认证：否

Query：

- `subject`（可选）
- `keyword`（可选）

### 6.4 管理端 CRUD（建议）

（示例，均需管理员权限）

- `POST /api/v1/admin/categories`
- `PUT /api/v1/admin/categories/{id}`
- `POST /api/v1/admin/problem-types`
- `PUT /api/v1/admin/problem-types/{id}`
- `POST /api/v1/admin/tags`

## 7. 题单/合集（Collection）

### 7.1 创建题单

- `POST /api/v1/collections`
- 认证：是

请求：

```json
{
  "name": "不等式训练",
  "description": "按题型整理",
  "visibility": "PUBLIC"
}
```

响应：返回 `id/status/shareKey`

### 7.2 题单详情

- `GET /api/v1/collections/{id}`
- 认证：按可见性决定（同题目）

### 7.3 添加题目到题单

- `POST /api/v1/collections/{id}/items`
- 认证：是（仅作者）

请求：

```json
{
  "problemId": 1001,
  "sortOrder": 0
}
```

### 7.3.1 从题单移除题目（MVP）

- `DELETE /api/v1/collections/{id}/items/{problemId}`
- 认证：是（仅作者）

### 7.3.2 更新/删除题单（MVP）

- `PUT /api/v1/collections/{id}`：更新题单（名称/简介/可见性）
- `DELETE /api/v1/collections/{id}`：删除题单（软删除）

### 7.3.3 收藏题单（MVP）

- `POST /api/v1/collections/{id}/favorite`
- `DELETE /api/v1/collections/{id}/favorite`

### 7.4 调整题单顺序（建议）

- `PUT /api/v1/collections/{id}/items/reorder`

请求：

```json
{
  "items": [
    { "problemId": 1001, "sortOrder": 10 },
    { "problemId": 1002, "sortOrder": 20 }
  ]
}
```

### 7.5 仅链接访问

- `GET /api/v1/collections/share/{shareKey}`

## 8. 每日一题（Daily Problem）

### 8.1 今日每日一题

- `GET /api/v1/daily-problem/today`
- 认证：否

响应：

```json
{
  "code": 0,
  "message": "OK",
  "data": [
    {
      "id": 90001,
      "day": "2026-01-28",
      "copywriting": "今日推荐：注意构造",
      "problem": { "id": 1001, "title": "...", "subject": "MATH", "difficulty": 3 }
    }
  ]
}
```

### 8.2 指定日期每日一题

- `GET /api/v1/daily-problem`
- 认证：否

Query：

- `day=YYYY-MM-DD`

### 8.3 历史列表（建议）

- `GET /api/v1/daily-problems`
- 认证：否

Query：

- `from=YYYY-MM-DD`
- `to=YYYY-MM-DD`
- `page`、`pageSize`（或直接按范围返回）

### 8.4 管理端发布/替换/撤回（建议）

- `POST /api/v1/admin/daily-problems`（发布；同一天可多条）
- `POST /api/v1/admin/daily-problems/{day}/revoke`（撤回当天全部）
- `POST /api/v1/admin/daily-problem-items/{id}/revoke`（按 ID 撤回单条）

## 9. 举报（Report）

### 9.1 创建举报

- `POST /api/v1/reports`
- 认证：是

请求：

```json
{
  "targetType": "PROBLEM",
  "targetId": 1001,
  "reason": "疑似侵权/内容不当"
}
```

### 9.2 管理端举报列表

- `GET /api/v1/admin/reports`
- 认证：是（管理员）

Query（可选）：

- `targetType=PROBLEM/COMMENT`
- `status=OPEN/RESOLVED/REJECTED`
- `page`、`pageSize`

### 9.3 管理端更新举报状态

- `POST /api/v1/admin/reports/{id}/status`
- 认证：是（管理员）

请求：

```json
{
  "status": "RESOLVED",
  "note": "已下架内容"
}
```

（均需管理员/运营权限）

- 发布或替换：`POST /api/v1/admin/daily-problems`

请求：

```json
{
  "day": "2026-01-28",
  "problemId": 1001,
  "copywriting": "今日推荐：..."
}
```

- 撤回：`POST /api/v1/admin/daily-problems/{day}/revoke`

## 9. 待确认点（影响实现）

1) 审核策略：当前已取消“先审后发”，题目由作者直接发布（无 `/submit-review` 与审核后台）
2) UNLISTED 访问策略：仅通过 `shareKey` 访问，还是允许登录用户也可直接访问 `id`？
3) 搜索范围：MVP 是否仅搜索 `title`，还是同时搜索题干/解答？
4) 题干/解答是否允许分别选择格式（本文档建议支持分别选择，最灵活）。
